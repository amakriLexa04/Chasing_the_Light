#textdomain wesnoth-chasing_the_light

# "C" stands for "conditional"
#define GENERIC_UNITC SIDE TYPE X Y WML
    {VARIABLE generic_unitc {TYPE}}
    [if] {VARIABLE_CONDITIONAL generic_unitc not_equals "none"}
        {THEN(  {GENERIC_UNIT {SIDE} {TYPE} {X} {Y}} {WML}  )}
    [/if]
    {CLEAR_VARIABLE generic_unitc}
#enddef
#define NAMED_UNITC SIDE TYPE X Y ID NAME WML
    {VARIABLE named_unitc {TYPE}}
    [if] {VARIABLE_CONDITIONAL named_unitc not_equals "none"}
        {THEN( {NAMED_UNIT {SIDE} {TYPE} {X} {Y} {ID} {NAME} ()} {WML} )}
    [/if]
    {CLEAR_VARIABLE named_unitc}
#enddef

#define FIRE_EVENT NAME
    #
    [fire_event]
        name={NAME}
    [/fire_event]
#enddef

#define VALUE WML
    #
    [value]
        {WML}
    [/value]
#enddef

#define ANIMATE
    [+unit]
        animate=yes
    [/unit]
#enddef

#define SOUND FILE
    #
    [sound]
        name={FILE}
    [/sound]
#enddef

#define DELAY TIME
    [delay]
        time={TIME}
    [/delay]
#enddef

#define SCREEN_FADER RGB ALPHA DURATION
    [screen_fade]
        red,green,blue={RGB}
        alpha={ALPHA}
        duration={DURATION}
    [/screen_fade]
#enddef

#define MODIFY_TERRAIN_DELAY MS TERRAIN X Y
    {DELAY {MS}}
    {MODIFY_TERRAIN {TERRAIN} {X} {Y}}
    [redraw]
    [/redraw]
#enddef

#define REMOVE_OBJECT OBJECT_ID FILTER_WML
    #
    [remove_object]
        object_id={OBJECT_ID}
        {FILTER_WML}
    [/remove_object]
#enddef
#define GIVE_OBJECT_TO FLT WML
    #
    [modify_unit]
        {FILTER {FLT}}
        [object]
            {WML}
        [/object]
    [/modify_unit]
    #
#enddef
#define EFFECT APPLY_TO WML
    #
    [effect]
        apply_to={APPLY_TO}
        {WML}
    [/effect]
    #
#enddef

# primitive macros for fading music. Only supports durations in increments of 100ms, and doesn't work with 0 durations
#define FADE_MUSIC_IN DURATION
    #
    {VARIABLE fade_duration_remaining {DURATION}}
    [while] {VARIABLE_CONDITIONAL fade_duration_remaining greater_than 0}
        [do]
            {VARIABLE_OP fade_duration_remaining sub 100}
            {VARIABLE volume 100}
            {VARIABLE_OP volume multiply $fade_duration_remaining}
            {VARIABLE_OP volume divide {DURATION}}
            {VARIABLE volume "$(100-$volume)"}
            [volume]
                music=$volume
            [/volume]
            {DELAY 100}
        [/do]
    [/while]
    {CLEAR_VARIABLE fade_duration_remaining,volume}
    #
#enddef
#define FADE_MUSIC_OUT DURATION
    #
    {VARIABLE fade_duration_remaining {DURATION}}
    [while] {VARIABLE_CONDITIONAL fade_duration_remaining greater_than 0}
        [do]
            {VARIABLE_OP fade_duration_remaining sub 100}
            {VARIABLE volume 100}
            {VARIABLE_OP volume multiply $fade_duration_remaining}
            {VARIABLE_OP volume divide {DURATION}}
            [volume]
                music=$volume
            [/volume]
            {DELAY 100}
        [/do]
    [/while]
    {CLEAR_VARIABLE fade_duration_remaining,volume}
    #
#enddef

#define VARIABLES_SPLIT NAME KEY SEPARATOR LIST
    #
    [set_variables]
        name={NAME}
        [split]
            key={KEY}
            separator={SEPARATOR}
            list={LIST}
        [/split]
    [/set_variables]
    #
#enddef

#define KILL FILTER
#arg ANIMATE
no#endarg
#arg FIRE_EVENT
no#endarg
    [kill]
        {FILTER}
        animate={ANIMATE}
        fire_event={FIRE_EVENT}
    [/kill]
#enddef

# copied (with modifications) from https://wiki.wesnoth.org/WML_Utilities
#define FIND_NEARBY FILTER X Y LIMIT
    # Does a search for a nearby unit that matches the given filter.
    # Basically just looks for such a unit with increasing radius until it finds at least one
    [clear_variable]
        name=found_unit
    [/clear_variable]
    [set_variable]
        name=search_radius
        value=0
    [/set_variable]
    [while]
        [not]
            [variable]
                name=found_unit.length
                greater_than=0
            [/variable]
        [/not]
        [and]
            [variable]
                name=search_radius
                less_than_equal_to={LIMIT}
            [/variable]
        [/and]
        [do]
            #             {DEBUG "Searching depth $search_radius around ({X}, {Y})..."}
            [store_unit]
                variable=found_unit
                [filter]
                    {FILTER}
                    [filter_location]
                        x,y={X},{Y}
                        radius=$search_radius
                    [/filter_location]
                [/filter]
            [/store_unit]
            #             {DEBUG "...found $found_unit.length units."}
            [set_variable]
                name=search_radius
                add=1
            [/set_variable]
        [/do]
    [/while]
#enddef

#define SPAWN_IF_UNFOUND SIDE TYPE X Y
    [set_variable]
        name=randx
        rand={X}
    [/set_variable]
    [set_variable]
        name=randy
        rand={Y}
    [/set_variable]

    {IF_UNFOUND}
    [then]
        {NAMED_UNIT {SIDE} ({TYPE}) $randx $randy spawned () ()} {ANIMATE}
        [store_unit]
            variable=found_unit
            [filter]
                id=spawned
            [/filter]
        [/store_unit]
    [/then]
    {ENDIF}

    {CLEAR_VARIABLE randx}
    {CLEAR_VARIABLE randy}
#enddef

#define CLEANUP_SEARCH
    # Clears variables involved in searching (the FIND_NEARBY macro). Put this
    # in your name=victory,defeat tag to clean up if you use FIND_NEARBY within
    # a scenario.
    [clear_variable]
        name=found_unit, search_radius
    [/clear_variable]
#enddef

#define IMMOBILE
    [+unit]
        max_moves=0
    [/unit]
#enddef
#define PASSABLE
    [+unit]
        passable=yes
    [/unit]
#enddef

#define MOVES MAX_MOVES
    [+unit]
        max_moves={MAX_MOVES}
    [/unit]
#enddef

#define HITPOINTS HP
    [+unit]
        hitpoints={HP}
    [/unit]
#enddef

#define EXPERIENCE XP
    [+unit]
        experience={XP}
    [/unit]
#enddef

#define STATUS WML
    [+unit]
        [status]
            {WML}
        [/status]
    [/unit]
#enddef

#define GENDER GND
    [+unit]
        gender={GND}
    [/unit]
#enddef

#define NAME UNITNAME
    [+unit]
        name={UNITNAME}
    [/unit]
#enddef

#define ROLE ROLENAME
    [+unit]
        role={ROLENAME}
    [/unit]
#enddef

#define MODIFICATIONS WML
    #
    [modifications]
        {WML}
    [/modifications]
#enddef

#define ADD_MODIFICATION WML
    [+unit]
        [modifications]
            {WML}
        [/modifications]
    [/unit]
#enddef

#define MOVE_STORED_UNIT VAR MOVEX MOVEY
    [set_variable]
        name={VAR}.x
        add={MOVEX}
    [/set_variable]
    [set_variable]
        name={VAR}.y
        add={MOVEY}
    [/set_variable]
#enddef

#define SAY_IF_NOT_SUMMON UNIT MESSAGE
    # special voicelines for summons
    [if]{VARIABLE_CONDITIONAL {UNIT}.id equals familiar}
        {OR({VARIABLE_CONDITIONAL {UNIT}.type equals "Mudcrawler"})}
        {OR({VARIABLE_CONDITIONAL {UNIT}.type equals "Giant Mudcrawler"})}
        {OR({VARIABLE_CONDITIONAL {UNIT}.type equals "Fire Guardian"})}
        {OR({VARIABLE_CONDITIONAL {UNIT}.type equals "Fire Wraith"})}
        {THEN(
            [if] {VARIABLE_CONDITIONAL {UNIT}.id equals familiar}
                {THEN([message]
                speaker={UNIT}
                message=_"Kraa!"
            [/message])} [/if]

            [if]{VARIABLE_CONDITIONAL {UNIT}.type equals "Mudcrawler"}
                {OR({VARIABLE_CONDITIONAL {UNIT}.type equals "Giant Mudcrawler"})}
                {THEN([message]
                speaker={UNIT}
                message=_"Glob glob glob."
            [/message])} [/if]

            [if]{VARIABLE_CONDITIONAL {UNIT}.type equals "Mudcrawler"}
                {OR({VARIABLE_CONDITIONAL {UNIT}.type equals "Giant Mudcrawler"})}
                {THEN([message]
                speaker={UNIT}
                message=_"Fsss crackle hiss."
            [/message])} [/if]

            [message]
                speaker=haralin
                message={MESSAGE}
            [/message]
        )}

        # otherwise, the regular unit gives the message
        {ELSE(
            [message]
                speaker={UNIT}
                message={MESSAGE}
            [/message]
        )} [/if]
#enddef

#define GOLD_PICKUP X Y IMAGE AMOUNT LABEL MESSAGE
    {PLACE_IMAGE {IMAGE} {X} {Y}}
    {SET_LABEL {X} {Y} {LABEL}}
    [event]
        name=moveto {FILTER side,x,y=1,{X},{Y}}
        id=gold_pickup_{X}_{Y} # so we can remove this
        {SAY_IF_NOT_SUMMON unit {MESSAGE}}
        {SOUND gold.ogg}
        [gold]
            side,amount=1,{AMOUNT}
        [/gold]
        {REMOVE_IMAGE $unit.x $unit.y}
        {REMOVE_LABEL {X} {Y}}
    [/event]
#enddef

#define STORE_SELECTED_UNITS STORE_VARIABLE
    [store_unit]
        kill=yes
        mode=append
        variable={STORE_VARIABLE}
        [filter]
            id=$unit.id
        [/filter]
    [/store_unit]
#enddef

#define UNSTORE_SELECTED_UNITS STORE_VARIABLE
    [foreach]
        array={STORE_VARIABLE}
        [do]
            [unstore_unit]
                variable=this_item
                find_vacant=yes
                x=recall
                y=recall
            [/unstore_unit]
            {FULL_HEAL id=$this_item.id}
        [/do]
    [/foreach]

    {CLEAR_VARIABLE {STORE_VARIABLE}}
#enddef

#define SECOND_TRIAL_RENEW
    [if]
        [have_unit]
            type=Wose
        [/have_unit]
        [then]
            [animate_unit]
                flag=attack
                [filter]
                    id=wose
                [/filter]
                [frame]
                    image="units/woses/wose.png"
                    halo="halo/woses/shaman-stationary-halo[1~8].png:150"
                [/frame]
            [/animate_unit]

            [sound]
                name=entangle.wav
            [/sound]
        [/then]
        [else]
            [animate_unit]
                flag=attack
                [filter]
                    id=wose
                [/filter]
                [primary_attack]
                    range=ranged
                [/primary_attack]
            [/animate_unit]
        [/else][/if]

        [kill]
            side=2
            [not]
                id=quintain1,quintain2,quintain3,quintain4,quintain5
            [/not]
        [/kill]

        {QUAKE (rumble.ogg)}
        {DELAY 1000}

        [terrain]
            x=32,33
            y=17,17
            terrain=Gg
        [/terrain]
        {GENERIC_UNITC 2 "Quintain" 33  17 ()}
        [redraw][/redraw]

        [terrain]
            x=30,31
            y=13,14
            terrain=Gg
        [/terrain]
        {GENERIC_UNITC 2 "Quintain" 30  13 ()}
        [redraw][/redraw]

        [terrain]
            x=33,34
            y=11,10
            terrain=Gg
        [/terrain]
        {GENERIC_UNITC 2 "Quintain" 34  10 ()}
        [redraw][/redraw]

        [terrain]
            x=33,34
            y=8,7
            terrain=Gg
        [/terrain]
        {GENERIC_UNITC 2 "Quintain" 30  8 ()}
        [redraw][/redraw]

        {GENERIC_UNITC 2 "Quintain" 34  7 ()}

        [modify_unit]
            [filter]
                id=daeola
            [/filter]
            experience=24
            moves=5
        [/modify_unit]

        [scroll_to_unit]
            id=daeola
        [/scroll_to_unit]

        [set_variable]
            name=is_daeola_free_move
            value=_ "false"
        [/set_variable]
#enddef

#define MAGES_ONLY
    type=Wose, Wose Shaman, spirit_light,spirit_shadow, spirit_dark, Mage,Red Mage,Arch Mage,Silver Mage,White Mage,Mage of Light, Mage, Great Mage, haralin_1, haralin_2, haralin_3, haralin_3_dark, haralin_4, daeola_1, daeola_2, daeola_3, apprentice, mage_healer
#enddef

#define 05_KILL_GHOSTS X Y RADIUS
    [store_unit]
        [filter]
            type_adv_tree=Ghost
        [/filter]
        variable=units_to_check
    [/store_unit]

    {FOREACH units_to_check i}
        [set_variable]
            name=ghost_x
            value=$units_to_check[$i].x
        [/set_variable]

        [set_variable]
            name=ghost_y
            value=$units_to_check[$i].y
        [/set_variable]

        [set_variable]
            name=monolith_x
            value={X}
        [/set_variable]

        [set_variable]
            name=monolith_y
            value={Y}
        [/set_variable]

        [lua]
            code= <<
    local ghost_x = wesnoth.get_variable("ghost_x")
	local ghost_y = wesnoth.get_variable("ghost_y")
	local monolith_x = wesnoth.get_variable("monolith_x")
	local monolith_y = wesnoth.get_variable("monolith_y")
	wesnoth.set_variable("distance_to_monolith", wesnoth.map.distance_between(monolith_x, monolith_y, ghost_x, ghost_y))
    >>
        [/lua]

        [if]
            [variable]
                name=distance_to_monolith
                less_than_equal_to={RADIUS}
            [/variable]
            [then]
                [kill]
                    x,y=$units_to_check[$i].x,$units_to_check[$i].y
                    animate=yes
                [/kill]
            [/then]
        [/if]
    {NEXT i}

    {CLEAR_VARIABLE units_to_check}
    {CLEAR_VARIABLE ghost_x}
    {CLEAR_VARIABLE ghost_y}
    {CLEAR_VARIABLE monolith_x}
    {CLEAR_VARIABLE monolith_y}
#enddef

#define 05_DESTROY_MONOLITH MONOLITH_VARIABLE
    [scroll_to]
        x,y=$x1,$y1
    [/scroll_to]

    [kill]
        id=ghost
    [/kill]

    {FLASH_LIGHTNING ()}

    [remove_item]
        x,y=$x1,$y1
    [/remove_item]

    [terrain]
        x=$x1
        y=$y1
        terrain=Gll^Dr
        layer=overlay
    [/terrain]

    [redraw][/redraw]

    {05_KILL_GHOSTS $x1 $y1 9}

    [set_variable]
        name={MONOLITH_VARIABLE}
        value=_ "destroyed"
    [/set_variable]

    {VARIABLE_OP monolith add 1}
    [progress_achievement]
        content_for=wesnoth-Chasing_the_Light
        id="ctl_swamp_ghost"
        amount=1
        limit=$monolith
    [/progress_achievement]

    [if]
        [variable]
            name=monolith
            equals=5
        [/variable]
        [then]
            {SPEAK haralin _"Дякувати Світлу, схоже, це був останній моноліт. Мені відчутно як звільнені души покидають цей світ та радіє земля, проте, певно, пройде ще безліч років, перш ніж це прокляте болото повністю очиститься."}

            [objectives]
                [objective]
                    description=_ "Гаралін, Даеола та Аса мають дістатися до копальні на півночі"
                    condition=win
                [/objective]
                [objective]
                    description=_ "(альтернативно) Defeat all enemy leaders"
                    condition=win
                [/objective]
                [objective]
                    description=_ "<span strikethrough='true'>(додатково) Знищити всі прокляті моноліти</span>"
                    condition=win
                [/objective]
                [objective]
                    description= _ "Death of Haralin"
                    condition=lose
                [/objective]
                [objective]
                    description= _ "Death of Daeola"
                    condition=lose
                [/objective]
                [objective]
                    description= _ "Death of Asa"
                    condition=lose
                [/objective]
                {TURNS_RUN_OUT}
                [gold_carryover]
                    bonus=yes
                    carryover_percentage=40
                [/gold_carryover]
            [/objectives]
        [/then][/if]

#enddef

#define 05_KILL_ALL_NECRO_FRIENDS_WITH_BANDITS_BODY
    [kill]
        side=5
    [/kill]

    [redraw][/redraw]

    [set_achievement]
        content_for=wesnoth-Chasing_the_Light
        id="ctl_save_esten"
    [/set_achievement]

    {DELAY 500}

    {SPEAK peasant_hater _"У мене були погані відчуття щодо них, але я радий, що помилився."}
    {SPEAK asa _"Витрата припасів не була марною — вони допомогли."}
    {SPEAK haralin _"Клянуся Світлом, тільки що ми зробили добру справу, врятувавши тих нещасних людей. Проте ми не маємо відволікатися від головної мети — порятунку Графа Блекмору."}

    [set_variable]
        name=bandits_gone
        value=_ "true"
    [/set_variable]

    {05_KILL_VICTORY}

#enddef

#define 05_KILL_VAR_ALL
    [have_unit]
        id=esten_adept1
    [/have_unit]
    [or]
        [have_unit]
            id=esten_adept2
        [/have_unit]
    [/or]
    [or]
        [have_unit]
            id=esten_necro
        [/have_unit]
    [/or]
    [or]
        [have_unit]
            id=esten_scared_adept
        [/have_unit]
    [/or]
#enddef

#define 05_KILL_VAR_TURNS
    [have_unit]
        id=esten_adept1
    [/have_unit]
    [or]
        [have_unit]
            id=esten_adept2
        [/have_unit]
    [/or]
    [or]
        [have_unit]
            id=esten_necro
        [/have_unit]
    [/or]
#enddef

#define 05_KILL_ALL_NECRO_AND_BANDITS_VAR_ALL
    [have_unit]
        id=esten_adept1
    [/have_unit]
    [or]
        [have_unit]
            id=esten_adept2
        [/have_unit]
    [/or]
    [or]
        [have_unit]
            id=esten_necro
        [/have_unit]
    [/or]
    [or]
        [have_unit]
            id=esten_scared_adept
        [/have_unit]
    [/or]
    [or]
        [have_unit]
            id=esten_bandit
        [/have_unit]
    [/or]
#enddef

#define 05_KILL_ALL_NECRO_AND_BANDITS_VAR_TURNS
    [have_unit]
        id=esten_adept1
    [/have_unit]
    [or]
        [have_unit]
            id=esten_adept2
        [/have_unit]
    [/or]
    [or]
        [have_unit]
            id=esten_necro
        [/have_unit]
    [/or]
    [or]
        [have_unit]
            id=esten_bandit
        [/have_unit]
    [/or]
#enddef

#define 05_KILL_ALL_NECRO_FRIENDS_WITH_BANDITS_ALL VARS
    [if]
        [not]
            {VARS}
        [/not]
        [and]
            [variable]
                name=bandits_friendly
                equals=true
            [/variable]
        [/and]
        [then]
            {DELAY 500}
            [if]
                [have_unit]
                    id=esten_bandit
                [/have_unit]
                [then]
				    {SPEAK esten_bandit _"Походу, тце був останній злий чаклун, тому ми забираємося атсюда. Внатурі дякуєм за допомогу, ми цього не забудємо."}
                [/then]
                [else]
                    [message]
                        side=5
                        message= _ "Походу, тце був останній злий чаклун, тому ми забираємося атсюда. Внатурі дякуєм за допомогу, ми цього не забудємо."
                    [/message]
                [/else][/if]
                {05_KILL_ALL_NECRO_FRIENDS_WITH_BANDITS_BODY}
            [/then][/if]
#enddef

#define 05_KILL_ALL_NECRO_FRIENDS_WITH_BANDITS_TURNS VARS
    [if]
        [not]
            {VARS}
        [/not]
        [and]
            [variable]
                name=bandits_friendly
                equals=true
            [/variable]
        [/and]
        [then]
            {DELAY 500}
			{SPEAK asa _"Ми не маємо часу полювати на нього. Чаклуне, йдемо далі."}
            {SPEAK haralin _"Бачить Світло, ми припустимося великої помилки, дозволивши це, проте зараз вже запізно щось з цим робити."}

            [if]
                [have_unit]
                    id=esten_bandit
                [/have_unit]
                [then]
                    {SPEAK esten_bandit _"І справді, йдіть вже, ви вбили майже всіх, тож хай тот злий чаклун тікає, і ми забираємося атсюда. Внатурі дякуєм за допомогу, ми цього не забудємо."}
                [/then]
                [else]
                    [message]
                        side=5
                        message= _ "І справді, ви вже врятували все болото, тож хай тот злий чаклун тікає, і ми забираємося атсюда. Внатурі дякуєм за допомогу, ми цього не забудємо."
                    [/message]
                [/else][/if]
                {05_KILL_ALL_NECRO_FRIENDS_WITH_BANDITS_BODY}
            [/then][/if]
#enddef

#define 05_BANDITS_SEE_UNIT_GO_INSIDE
    [if]
        [have_unit]
            side=5
        [/have_unit]
        [and]
            [variable]
                name=bandits_friendly
                equals=false
            [/variable]
        [/and]
        [then]
            [if]
                [have_unit]
                    id=esten_bandit
                [/have_unit]
                [then]
                    {SPEAK esten_bandit _"Ей, хлопці, м'ясо само лізе в нашу пещеру, це прям свято якесь! А ну ловіть їх негайно!"}
                [/then]
                [else]
                    [message]
                        side=5
                        message= _ "Ей, хлопці, м'ясо само лізе в нашу пещеру, це прям свято якесь! А ну ловіть їх негайно!"
                    [/message]
                [/else][/if]

                {SPEAK haralin _"Клянуся самим Світлом, вам це не вдастся, людожерські мерзотники, бо ж загублені були ваші душі в ту мить, як повстали проти всього людського."}
            [/then][/if]
#enddef

#define PENELLA_DEATH
    {SPEAK esten_bandit _"Айх! Ми же не мали іншого вибору! Ми же просто... уфф... ми хотіли вижити!"}
    {SPEAK haralin _"Бачить Світло, жодне життя не варте того, щоб заради нього вбивати незнайомих вам людей, тим паче вчиняючи настільки мерзенний злочин — пожираючи собі подібних. Хай же буде само Світло тобі суддею, бо ж смерть не є достатньою карою!"}

    [scroll_to_unit]
        id=esten_bandit
    [/scroll_to_unit]

    {DELAY 700}

    {SPEAK esten_bandit _"Але ж.... УАГХ!..."}

    [sound]
        name=lightning.ogg
    [/sound]

    {FLASH_WHITE ()}

    [transform_unit]
        id=esten_bandit
        transform_to=Ghoul
    [/transform_unit]

    {SPEAK esten_bandit _"АААААААРГХ!"}

    [event]
        name=die
        [filter]
            id=esten_bandit
        [/filter]

        {DELAY 600}

        [if]
            [have_unit]
                id=daeola
            [/have_unit]
            [then]
                {SPEAK daeola _"Вчителю, що... Що це таке?.."}
            [/then]
            [else]
                [role]
                    side=1
                    role=scared_by_penella
                    [not]
                        id=haralin, peasant_hater
                    [/not]
                [/role]

                [message]
                    role=scared_by_penella
                    message= _ "Пане, що... Що це таке сталося?"
                [/message]
            [/else][/if]

            {SPEAK haralin _"Я й сам не знаю, як... проте, хвала Світлу, схоже, воно знову почуло мій заклик..."}

            [if]
                [have_unit]
                    id=bandit_entrance_guard
                    side=5
                [/have_unit]
                [then]
                    [scroll_to_unit]
                        id=bandit_entrance_guard
                    [/scroll_to_unit]

                    {MODIFY_UNIT id=bandit_entrance_guard facing sw} {DELAY 500}
                    {MODIFY_UNIT id=bandit_entrance_guard facing se} {DELAY 500}

                    {SPEAK bandit_entrance_guard _"Прокляття, я б помстився за Пенеллу, але еті чаклуни дуже сильні. Треба відступати до інших!"}

                    [store_unit]
                        [filter]
                            id=bandit_entrance_guard
                        [/filter]
                        variable=bandit_entrance_guard_stored
                        kill=yes
                    [/store_unit]

                    [set_variable]
                        name=is_entrance_guard_alive
                        value= _ "true"
                    [/set_variable]

                    [redraw][/redraw]

                    {DELAY 500}

                    {SPEAK asa _"Нас чекатиме битва в печері, ще одна затримка."}
                    {SPEAK daeola _"Це так, однак хоча б прохід всередину вже вільний. Нумо туди, доженемо того поганця!"}

                    [set_variable]
                        name=is_penella_dead
                        value= _ "true"
                    [/set_variable]

                    {05_KILL_ALL_NECRO_AND_BANDITS {05_KILL_ALL_NECRO_AND_BANDITS_VAR_ALL}}
                [/then][/if]
            [/event]

#enddef

#define 05_KILL_ALL_NECRO_AND_BANDITS VARS
    [if]
        [not]
            {VARS}
        [/not]
        [and]
            [variable]
                name=bandits_friendly
                equals=false
            [/variable]
        [/and]
        [then]
            {DELAY 500}

            [if]
                [variable]
                    name=monolith
                    equals=5
                [/variable]
                [then]
                    {SPEAK haralin _"Клянуся Світлом, тільки що ми зробили добру справу, очистивши це нещасне місце від стількох мерзенних речей. Проте ми не маємо відволікатися від головної мети — порятунку Графа Блекмору."}
                    {SPEAK asa _"Тепер рухаємося до входу в копальню, чаклуне."}
					{SPEAK hunter _"Ага, м'я палка файно тих мерців і нелюдів порішала! Але всередині точна сче гади б'дуть."}
                [/then]
                [else]
                    {SPEAK haralin _"Клянуся Світлом, тільки що ми зробили добру справу, очистивши це нещасне місце від мерців та людожерів, проте шкода, що ми не змогли знищити всі прокляті моноліти, тому неупокоєні духи продовжуватимуть тинятися цією місциною."}
                    {SPEAK daeola _"Однак ми вже зробили більш, ніж достатньо, Вчителю! Це справжнє диво, що наш малий загін зміг розбити ворожі сили, нумо, ходімо!"}
                    {SPEAK peasant_hater _"Даеола діло каже, Гараліне, нічого вже тут затримуватися — нам ще Графа Блекмору рятувати."}
                [/else][/if]

                [set_variable]
                    name=undead_gone
                    value= _ "true"
                [/set_variable]

                {05_KILL_VICTORY}
            [/then][/if]
#enddef

#define 05_KILL_ALL_NECRO_AND_BANDITS_TURNS VARS
    [if]
        [not]
            {VARS}
        [/not]
        [and]
            [variable]
                name=bandits_friendly
                equals=false
            [/variable]
        [/and]
        [then]
            {DELAY 500}

            [if]
                [variable]
                    name=monolith
                    equals=5
                [/variable]
                [then]
                    {SPEAK haralin _"Клянуся Світлом, тільки що ми зробили добру справу, очистивши це нещасне місце від стількох мерзенних речей. Проте ми ще маємо розібратися з тим біглим чаклуном, інакше все це зло з часом знову повернеться на болота."}
                    {SPEAK asa _"Ми не маємо часу полювати на нього. Чаклуне, йдемо далі."}
                    {SPEAK haralin _"Бачить Світло, ми припустимося великої помилки, дозволивши це, проте й справді — в нас нема часу, йдемо до копальні."}
                    {SPEAK hunter _"Ага, м'я палка файно тих мерців і нелюдів порішала! Але всередині точна сче гади б'дуть."}
                [/then]
                [else]
                    {SPEAK haralin _"Клянуся Світлом, тільки що ми зробили добру справу, очистивши це нещасне місце від мерців та людожерів, проте шкода, що ми не змогли знищити всі прокляті моноліти, тому неупокоєні духи продовжуватимуть тинятися цією місциною."}
                    {SPEAK daeola _"Ще й лишився отой біглий адепт, однак ми вже зробили більш, ніж достатньо, Вчителю! Це справжнє диво, що наш малий загін зміг розбити ворожі сили, нумо, ходімо!"}
                    {SPEAK peasant_hater _"Даеола діло каже, Гараліне, нічого вже тут затримуватися — нам ще Графа Блекмору рятувати."}
                [/else][/if]

                [set_variable]
                    name=undead_gone
                    value= _ "true"
                [/set_variable]

                {05_KILL_VICTORY}
            [/then][/if]
#enddef

#define 05_KILL_VICTORY
    [hide_unit]
        side=1,2,3,4,5,6
    [/hide_unit]

    {FADE_TO_BLACK}

    [kill]
        side=2,3,4,5,6
    [/kill]

    [put_to_recall_list]
        side=1
        [not]
            id=haralin,asa,daeola
        [/not]
    [/put_to_recall_list]

    [teleport]
        [filter]
            id=haralin
        [/filter]
        x,y=14,4
        animate=no
    [/teleport]

    {MODIFY_UNIT id=haralin facing nw}

    [teleport]
        [filter]
            id=daeola
        [/filter]
        x,y=15,6
        animate=no
    [/teleport]

    {MODIFY_UNIT id=daeola facing nw}

    [teleport]
        [filter]
            id=asa
        [/filter]
        x,y=13,5
        animate=no
    [/teleport]

    {MODIFY_UNIT id=asa facing nw}

    [scroll_to_unit]
        id=asa
    [/scroll_to_unit]

    {FADE_IN}

    [unhide_unit]
        side=1
    [/unhide_unit]

    [redraw][/redraw]

    {DELAY 1000}

    [move_unit]
        id=asa
        to_x,to_y=12,3
        fire_event=yes
    [/move_unit]

    {DELAY 500}

    [move_unit]
        id=daeola
        to_x,to_y=12,3
        fire_event=yes
    [/move_unit]

    [move_unit]
        id=haralin
        to_x,to_y=12,3
        fire_event=yes
    [/move_unit]

#enddef

#define 06_OPEN_WALL X Y

    [sound]
        name=explosion.ogg
    [/sound]

    [terrain]
        x,y={X},{Y}
        terrain=Uh
    [/terrain]

#enddef

#define SPEAK SPEAKER MESSAGE
    [message]
        speaker={SPEAKER}
        message={MESSAGE}
    [/message]
#enddef

#define CTL_REACTION HARALIN DAEOLA ASA HATER HUNTER WOSE OTHERS
    [if]
        [variable]
            name=unit.id
            equals=haralin
        [/variable]
        [then]
            {HARALIN}
        [/then]
        [elseif]
            [variable]
                name=unit.id
                equals=daeola
            [/variable]
            [then]
                {DAEOLA}
            [/then]
        [/elseif]
        [elseif]
            [variable]
                name=unit.id
                equals=asa
            [/variable]
            [then]
                {ASA}
            [/then]
        [/elseif]
        [elseif]
            [variable]
                name=unit.id
                equals=peasant_hater
            [/variable]
            [then]
                {HATER}
            [/then]
        [/elseif]
        [elseif]
            [variable]
                name=unit.id
                equals=hunter
            [/variable]
            [then]
                {HUNTER}
            [/then]
        [/elseif]
        [elseif]
            [variable]
                name=unit.id
                equals=wose
            [/variable]
            [then]
                {WOSE}
            [/then]
        [/elseif]
        [else]
            {OTHERS}
        [/else]
    [/if]
#enddef

#define CTL_REACTION_SECOND HARALIN DAEOLA ASA HATER HUNTER WOSE OTHERS
    [if]
        [variable]
            name=second_unit.id
            equals=haralin
        [/variable]
        [then]
            {HARALIN}
        [/then]
        [elseif]
            [variable]
                name=second_unit.id
                equals=daeola
            [/variable]
            [then]
                {DAEOLA}
            [/then]
        [/elseif]
        [elseif]
            [variable]
                name=second_unit.id
                equals=asa
            [/variable]
            [then]
                {ASA}
            [/then]
        [/elseif]
        [elseif]
            [variable]
                name=second_unit.id
                equals=peasant_hater
            [/variable]
            [then]
                {HATER}
            [/then]
        [/elseif]
        [elseif]
            [variable]
                name=second_unit.id
                equals=hunter
            [/variable]
            [then]
                {HUNTER}
            [/then]
        [/elseif]
        [elseif]
            [variable]
                name=second_unit.id
                equals=wose
            [/variable]
            [then]
                {WOSE}
            [/then]
        [/elseif]
        [else]
            {OTHERS}
        [/else]
    [/if]
#enddef

#define 06_OPEN_WALL_COMMENTARY_1
    [if]
    [variable]
        name=find_wall_crack
        equals=false
    [/variable]
    [then]
        {CTL_REACTION
        ({SPEAK haralin _"Клянуся Світлом, за цією потрісканою стіною щось є!"}) #haralin
        ({SPEAK daeola _"Схоже, за цією стіною є якийсь прохід. Моя магія допоможе відкрити його!"}) #daeola
        ({SPEAK asa _"Прохід за стіною."}) #asa
        ({SPEAK peasant_hater _"Схоже, за цією потрісканою стіною щось є. Сподіваюся, за ним не ховаються чаклуни чи чудовиська?.."}) #hater
        ({SPEAK hunter _"Еге, ж потайной праход... Усє девіться сюда!"}) #hunter
        ({SPEAK wose _"Коріння крушить землю наше, прохід ми помітили бо ж."}) #wose
        ({SPEAK unit _"Схоже, за цією потрісканою стіною щось є. Я зараз спробую її пробити."}) #others
        }
   [/then][/if]
#enddef

#define 06_OPEN_WALL_COMMENTARY_2
    [if]
    [variable]
        name=find_wall_crack
        equals=false
    [/variable]
    [then]	 
		{CTL_REACTION
        ({SPEAK haralin _"Будьте уважніше, у цих печерах має бути повно подібних проходів. Бачить Світло, усі ці нори та розломи є справою рук того ж нечестивця, що перетворив Естен на злиденне болото."}) #haralin
        ({SPEAK daeola _"Цікаво, чи тут є ще такі проходи? Певно, що так, це ж печера!"}) #daeola
        () #asa
        ({SPEAK peasant_hater _"Треба бути уважніше, можливо, ми знайдемо ще такі проходи."}) #hater
        ({SPEAK hunter _"Гой, будьтє уважніше. Тут точна ще такі є."}) #hunter
        ({SPEAK wose _"Уважніше, двоногі, озирайтеся ви. Мають проходи бути ще такі."}) #wose
        ({SPEAK unit _"Треба бути уважніше, можливо, ми знайдемо ще такі проходи."}) #others
        }
		
        [set_variable]
            name=find_wall_crack
            value=_ "true"
        [/set_variable]
    [/then][/if]

#enddef

#define 06_OTHERS_SEE_TABLET
    {CTL_REACTION
    () #haralin
    ({SPEAK daeola _"Вчителю, ви маєте на це подивитися, тут якісь дивні літери намальовані!"}) #daeola
    ({SPEAK asa _"Чаклуне, тобі варто поглянути."}) #asa
    ({SPEAK peasant_hater _"Тут щось написане — це все, що я можу сказати."}) #hater
    ({SPEAK hunter _"... Гараліне, тут чота напісано... іді почитай."}) #hunter
    ({SPEAK wose _"Давніх сліди двоногих. Мудрий двоногий, на це маєш подивитися ти."}) #wose
    ({SPEAK unit _"Пане Гараліне, погляньте, тут якісь стародавні символи."}) #others
    }
	
    [set_variable]
        name=saw_tablets
        value=_ "true"
    [/set_variable]
#enddef

#define 06_EXPLAIN_TABLETS

    [if]
    [variable]
        name=explained_tablets
        equals=false
    [/variable]
    [then]
        {SPEAK narrator ({CAPTION ( _ "???")} + _"Гараліне, щоб підкорити тутешніх духів, ти маєш прочитати послання Древніх у правильному порядку й лиш після того торкнутися місця сили. Ти вільний це зробити, проте, ім'ям Світла, не вірь жодним оманливим словам, що почуєш!")}

        [if]
        [have_unit]
            id=haralin
            x,y=18,16
        [/have_unit]
        [then]
            {MODIFY_UNIT id=haralin facing sw} {DELAY 500}
            {MODIFY_UNIT id=haralin facing se} {DELAY 500}
        [/then]
        [elseif]
        [have_unit]
            id=haralin
            x,y=20,13
        [/have_unit]
        [then]
            {MODIFY_UNIT id=haralin facing nw} {DELAY 500}
            {MODIFY_UNIT id=haralin facing ne} {DELAY 500}
        [/then][/elseif]
        [elseif]
        [have_unit]
            id=haralin
            x,y=20,16
        [/have_unit]
        [then]
            {MODIFY_UNIT id=haralin facing ne} {DELAY 500}
            {MODIFY_UNIT id=haralin facing nw} {DELAY 500}
        [/then][/elseif]
        [elseif]
            [have_unit]
                id=haralin
                x,y=20,15
            [/have_unit]
            [then]
                {MODIFY_UNIT id=haralin facing nw} {DELAY 500}
                {MODIFY_UNIT id=haralin facing ne} {DELAY 500}
            [/then][/elseif]
        [/if]

        {SPEAK haralin _"<i>Клянуся Світлом, я сумніваюся, що пращури людей нашого Острову, якщо ці таблички дійсно лишили вони, могли написати щось брехливе. Я не жодної підстави так вважати, тому без вагань підкорю духів каменю, бо ж мені та людям Скархейну потрібна їхня сила.</i>"}

        {DELAY 700}

        [set_variable]
            name=explained_tablets
            value=_ "true"
        [/set_variable]
    [/then][/if]

#enddef

#define CONVERSATION_CHECK_DISTANCE
    [lua]
        code= <<
    local speaker1_unit = wesnoth.get_units({ id = wesnoth.get_variable("speaker1") })[1]
	local speaker2_unit = wesnoth.get_units({ id = wesnoth.get_variable("speaker2") })[1]
	wesnoth.set_variable("distance_between_speakers", wesnoth.map.distance_between(speaker1_unit.x, speaker1_unit.y, speaker2_unit.x, speaker2_unit.y))
    >>
    [/lua]
#enddef

#define CONVERSATION UNIT1_ID UNIT2_ID START_TURN DELAY STAGE_PROGRESS STAGE1 STAGE2 STAGE3 STAGE4 STAGE5
    [event]
        name,first_time_only=side 1 turn refresh,yes
        [set_variable]
            name={STAGE_PROGRESS}
            value=1
        [/set_variable]

        [set_variable]
            name=speaker1
            value={UNIT1_ID}
        [/set_variable]

        [set_variable]
            name=speaker2
            value={UNIT2_ID}
        [/set_variable]

        [set_variable]
            name=next_stage_delay
            value={DELAY}
        [/set_variable]
    [/event]

    [event]
        name,first_time_only=side 1 turn refresh,no
        {FILTER_CONDITION( {VARIABLE_CONDITIONAL turn_number greater_than_equal_to {START_TURN}}  )}

        {CONVERSATION_CHECK_DISTANCE}

        [if]
            [variable]
                name=distance_between_speakers
                less_than_equal_to=2
            [/variable]
            [and]
                [variable]
                    name={STAGE_PROGRESS}
                    equals=1
                [/variable]
            [/and]
            [and]
                [have_unit]
                    id=$speaker1
                [/have_unit]
            [/and]
            [and]
                [have_unit]
                    id=$speaker2
                [/have_unit]
            [/and]
            [then]
                {STAGE1}
                [set_variable]
                    name={STAGE_PROGRESS}
                    value=2
                [/set_variable]

                [set_variable]
                    name=next_stage_turn
                    value="$($turn_number + $next_stage_delay)"
                [/set_variable]
            [/then][/if]
        [/event]

        [event]
            name,first_time_only=side 1 turn refresh,no
            {FILTER_CONDITION( {VARIABLE_CONDITIONAL turn_number greater_than_equal_to $next_stage_turn}  )}

            {CONVERSATION_CHECK_DISTANCE}

            [if]
                [variable]
                    name=distance_between_speakers
                    less_than_equal_to=2
                [/variable]
                [and]
                    [variable]
                        name={STAGE_PROGRESS}
                        equals=2
                    [/variable]
                [/and]
                [and]
                    [have_unit]
                        id=$speaker1
                    [/have_unit]
                [/and]
                [and]
                    [have_unit]
                        id=$speaker2
                    [/have_unit]
                [/and]
                [then]
                    {STAGE2}
                    [set_variable]
                        name={STAGE_PROGRESS}
                        value=3
                    [/set_variable]

                    [set_variable]
                        name=next_stage_turn
                        value="$($turn_number + $next_stage_delay)"
                    [/set_variable]
                [/then][/if]
            [/event]

            [event]
                name,first_time_only=side 1 turn refresh,no
                {FILTER_CONDITION( {VARIABLE_CONDITIONAL turn_number greater_than_equal_to $next_stage_turn}  )}

                {CONVERSATION_CHECK_DISTANCE}

                [if]
                    [variable]
                        name=distance_between_speakers
                        less_than_equal_to=2
                    [/variable]
                    [and]
                        [variable]
                            name={STAGE_PROGRESS}
                            equals=3
                        [/variable]
                    [/and]
                    [and]
                        [have_unit]
                            id=$speaker1
                        [/have_unit]
                    [/and]
                    [and]
                        [have_unit]
                            id=$speaker2
                        [/have_unit]
                    [/and]
                    [then]
                        {STAGE3}
                        [set_variable]
                            name={STAGE_PROGRESS}
                            value=4
                        [/set_variable]

                        [set_variable]
                            name=next_stage_turn
                            value="$($turn_number + $next_stage_delay)"
                        [/set_variable]
                    [/then][/if]
                [/event]

                [event]
                    name,first_time_only=side 1 turn refresh,no
                    {FILTER_CONDITION( {VARIABLE_CONDITIONAL turn_number greater_than_equal_to $next_stage_turn}  )}

                    {CONVERSATION_CHECK_DISTANCE}

                    [if]
                        [variable]
                            name=distance_between_speakers
                            less_than_equal_to=2
                        [/variable]
                        [and]
                            [variable]
                                name={STAGE_PROGRESS}
                                equals=4
                            [/variable]
                        [/and]
                        [and]
                            [have_unit]
                                id=$speaker1
                            [/have_unit]
                        [/and]
                        [and]
                            [have_unit]
                                id=$speaker2
                            [/have_unit]
                        [/and]
                        [then]
                            {STAGE4}
                            [set_variable]
                                name={STAGE_PROGRESS}
                                value=5
                            [/set_variable]

                            [set_variable]
                                name=next_stage_turn
                                value="$($turn_number + $next_stage_delay)"
                            [/set_variable]
                        [/then][/if]
                    [/event]

                    [event]
                        name,first_time_only=side 1 turn refresh,no
                        {FILTER_CONDITION( {VARIABLE_CONDITIONAL turn_number greater_than_equal_to $next_stage_turn}  )}

                        {CONVERSATION_CHECK_DISTANCE}

                        [if]
                            [variable]
                                name=distance_between_speakers
                                less_than_equal_to=2
                            [/variable]
                            [and]
                                [variable]
                                    name={STAGE_PROGRESS}
                                    equals=5
                                [/variable]
                            [/and]
                            [and]
                                [have_unit]
                                    id=$speaker1
                                [/have_unit]
                            [/and]
                            [and]
                                [have_unit]
                                    id=$speaker2
                                [/have_unit]
                            [/and]
                            [then]
                                {STAGE5}

                                {CLEAR_VARIABLE {STAGE_PROGRESS}}
                                {CLEAR_VARIABLE next_stage_turn}
                                {CLEAR_VARIABLE next_stage_delay}
                                {CLEAR_VARIABLE speaker1}
                                {CLEAR_VARIABLE speaker2}
                                {CLEAR_VARIABLE distance_between_speakers}
                            [/then][/if]
                        [/event]

#enddef

#define CAVES_ABOUT_CANNIBALS
    [if]
    [variable]
        name=know_about_cannibals
        equals=false
    [/variable]
    [then]
	
	{SPEAK haralin _"Клянуся Світлом, тепер я не маю жодних сумнівів — жителі колись благородного міста Естен перетворилися на проклятих людожерів, яким, як і західнякам, не місце на Зеленому Острові!"}
	{SPEAK peasant_hater _"Я теж це помітив, занадто дивною була їхня поведінка та їхні слова. Наші давні звичаї гласять, що подібні злочини має суворо каратися силами Короля. То ж що робитимеш, сержанте?"}
	{SPEAK asa _"Вирок за людожерство — смерть, але можливість виконати вирок було втрачено."}
	{SPEAK daeola _"Це жахливо... Однак, Вчителю, невже ви й справді не помітили нічого дивного? Ті люди увесь час дивилися на нас голодними поглядами, хоч і намагалися здаватися дружніми."}
	{SPEAK haralin _"Я не знаю, Даеоло... Я помітив його надту бліду шкіру, голодні жадібні очі, і моє чуття, йому зовсім це не сподобалося. Клянуся Світлом, у темні часи люди здатні на все, проте те, що я відчув на болотах... Я відмовлявся в це вірити."}
	
	[set_variable]
        name=know_about_cannibals
        value=_ "true"
    [/set_variable]
	[/then][/if]
#enddef



#define GRAVES_LABELS X Y TEXT IMAGE
    [event]
	name=moveto
	[filter]
	    x,y={X},{Y}
		side=1
	[/filter]
	
	[message]
        speaker=narrator
        message= {TEXT}
		image={IMAGE}
    [/message]
	
	##писати коментарі юнітів тут
	
	{VARIABLE_OP graves_notes add 1}
	[progress_achievement]
        content_for=wesnoth-Chasing_the_Light
        id="ctl_read_graves"
        amount=1
        limit=$graves_notes
    [/progress_achievement]
	
	[/event]
#enddef

#define NPC_LOOK_AT_UNIT NPC_X NPC_Y

	[if]
	[variable]
	name=unit.x
	less_than={NPC_X}
	[/variable]
	[and]
	[variable]
	name=unit.y
	less_than={NPC_Y}
	[/variable]
	[/and]
	[then]
	[modify_unit]
	[filter]
	x,y={NPC_X},{NPC_Y}
	[/filter]
	facing=nw
	[/modify_unit]
	[/then]
	
	
	[elseif]
	[variable]
	name=unit.x
	greater_than={NPC_X}
	[/variable]
	[and]
	[variable]
	name=unit.y
	less_than={NPC_Y}
	[/variable]
	[/and]
	[then]
	[modify_unit]
	[filter]
	x,y={NPC_X},{NPC_Y}
	[/filter]
	facing=ne
	[/modify_unit]
	[/then][/elseif]
	
	
	[elseif]
	[variable]
	name=unit.x
	equals={NPC_X}
	[/variable]
	[and]
	[variable]
	name=unit.y
	less_than={NPC_Y}
	[/variable]
	[/and]
	[then]
	[modify_unit]
	[filter]
	x,y={NPC_X},{NPC_Y}
	[/filter]
	facing=n
	[/modify_unit]
	[/then][/elseif]
	
	
	[elseif]
	[variable]
	name=unit.x
	equals={NPC_X}
	[/variable]
	[and]
	[variable]
	name=unit.y
	greater_than={NPC_Y}
	[/variable]
	[/and]
	[then]
	[modify_unit]
	[filter]
	x,y={NPC_X},{NPC_Y}
	[/filter]
	facing=s
	[/modify_unit]
	[/then][/elseif]
	
	
	
	
	
	[elseif]
	[variable]
	name=unit.x
	greater_than={NPC_X}
	[/variable]
	[and]
	[variable]
	name=unit.y
	greater_than_equal_to={NPC_Y}
	[/variable]
	[/and]
	[then]
	[modify_unit]
	[filter]
	x,y={NPC_X},{NPC_Y}
	[/filter]
	facing=se
	[/modify_unit]
	[/then][/elseif]
	
	
	
	[elseif]
	[variable]
	name=unit.x
	less_than={NPC_X}
	[/variable]
	[and]
	[variable]
	name=unit.y
	greater_than_equal_to={NPC_Y}
	[/variable]
	[/and]
	[then]
	[modify_unit]
	[filter]
	x,y={NPC_X},{NPC_Y}
	[/filter]
	facing=sw
	[/modify_unit]
	[/then][/elseif]
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	[/if]
	
	[redraw][/redraw]


#enddef
